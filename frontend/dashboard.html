<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GreenTrace ‚Äî Dashboard</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root {
      --primary: #2e7d32;
      --accent: #4caf50;
      --light: #f4fff4;
      --card: #ffffff;
      --text: #163d2c;
      --muted: #6b6b6b;
      --border: #e6efe6;
      --radius: 10px;
      --max-width: 1200px;
      --shadow: 0 6px 18px rgba(0,0,0,0.06);
    }
    [data-theme="dark"] {
      --primary: #4caf50;
      --accent: #81c784;
      --light: #121212;
      --card: #1e1e1e;
      --text: #f0f0f0;
      --muted: #a0a0a0;
      --border: #333;
      --shadow: 0 6px 18px rgba(0,0,0,0.4);
    }
    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: var(--light);
      color: var(--text);
      min-height: 100vh;
    }
    /* NAV */
    .nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 18px;
      max-width: var(--max-width);
      margin: 0 auto;
      flex-wrap: wrap;
    }
    .brand {
      display: flex;
      align-items: center;
      text-decoration: none;
      color: var(--primary);
      font-weight: 700;
      font-size: 1.5rem;
      gap: 8px;
    }
    .logo-img {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.8rem;
    }
    .tagline {
      font-size: 0.9rem;
      color: var(--accent);
      margin-top: 4px;
      font-style: italic;
    }
    .nav-left { display: flex; flex-direction: column; align-items: flex-start; }
    .nav-links { display: flex; flex-wrap: wrap; gap: 14px; align-items: center; }
    .nav-links a {
      text-decoration: none;
      color: var(--text);
      font-weight: 500;
      transition: color 0.3s;
    }
    .nav-links a:hover { color: var(--primary); }
    .dark-toggle {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 1.3rem;
      color: var(--text);
      transition: transform 0.3s;
    }
    .dark-toggle:hover { transform: rotate(15deg); }

    /* Dashboard */
    .dashboard { max-width: var(--max-width); margin: 0 auto; padding: 20px; }
    .welcome-section {
      background: linear-gradient(135deg, rgba(46, 125, 50, 0.1), rgba(76, 175, 80, 0.05));
      border-radius: var(--radius);
      padding: 30px;
      margin-bottom: 30px;
      border: 1px solid var(--border);
    }
    .welcome-section h1 { color: var(--primary); margin: 0; font-size: 2rem; }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 24px;
      text-align: center;
      border: 1px solid var(--border);
      transition: transform 0.3s;
    }
    .stat-card:hover {
      transform: translateY(-5px);
    }
    .stat-number { font-size: 2.2rem; color: var(--primary); font-weight: 700; }
    .stat-label { color: var(--muted); font-size: 0.9rem; }
    .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
    .map-section, .actions-section, .charts-section {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 24px;
      border: 1px solid var(--border);
    }
    #map { width: 100%; height: 400px; border-radius: var(--radius); }
    .section-title { color: var(--primary); margin-bottom: 10px; font-weight: 600; }
    .quick-actions { display: flex; flex-direction: column; gap: 12px; }
    .action-btn {
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 14px 18px;
      border-radius: var(--radius);
      text-decoration: none;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .action-btn:hover { background: var(--primary); color: white; transform: translateY(-2px); }
    .footer { text-align: center; color: var(--muted); margin-top: 40px; padding: 20px 0; border-top: 1px solid var(--border); }
    @media (max-width: 768px) {
      .nav { flex-direction: column; }
      .nav-links { justify-content: center; }
      .dashboard-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="nav" aria-label="Main navigation">
    <div class="nav-left">
      <a class="brand" href="index.html">
      <img src="../frontend/images/image.png" alt="GreenTrace logo" class="logo-img" />
      <span>GreenTrace</span>
      </a>
      <p class="tagline">Track and Celebrate Tree Planting</p>
    </div>
    <div class="nav-links">
      <a href="dashboard.html" style="color:var(--accent);font-weight:bold;">Dashboard</a>
      <a href="add-tree.html">My Trees</a>
      <a href="ai-scout.html">AI Scout</a>
      <a href="leaderboard.html">Leaderboard</a>
      <a href="#" onclick="logout()">Logout</a>
      <button id="darkModeToggle" class="dark-toggle">üåô</button>
    </div>
  </nav>

  <!-- DASHBOARD -->
  <main class="dashboard">
    <section class="welcome-section">
      <h1 id="welcomeMessage">Welcome back to GreenTrace!</h1>
      <p>Here's your current tree planting impact üå±</p>
    </section>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="totalTrees">0</div>
        <div class="stat-label">Total Trees Planted</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="verifiedTrees">0</div>
        <div class="stat-label">AI Verified Trees</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="speciesCount">0</div>
        <div class="stat-label">Unique Species</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="co2Offset">0 kg</div>
        <div class="stat-label">Estimated CO‚ÇÇ Offset</div>
      </div>
    </div>

    <div class="dashboard-grid">
      <div>
        <section class="map-section">
          <h3 class="section-title">Your Tree Map</h3>
          <div id="map"></div>
          <p id="mapInfo" style="margin-top:10px;color:var(--muted);"></p>
        </section>
      </div>

      <div>
        <section class="actions-section">
          <h3 class="section-title">Quick Actions</h3>
          <div class="quick-actions">
            <a href="add-tree.html" class="action-btn">üå≥ Add New Tree</a>
            <a href="ai-scout.html" class="action-btn">üõ∞Ô∏è Explore Land with AI</a>
            <a href="leaderboard.html" class="action-btn">üèÜ View Leaderboard</a>
          </div>
        </section>
      </div>
    </div>

    <footer class="footer">Powered by SDG 15 ‚Äî Life on Land</footer>
  </main>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // üåô Theme toggle
    const darkModeToggle = document.getElementById("darkModeToggle");
    const theme = localStorage.getItem("theme") || "light";
    document.body.setAttribute("data-theme", theme);
    darkModeToggle.textContent = theme === "dark" ? "‚òÄÔ∏è" : "üåô";
    darkModeToggle.addEventListener("click", () => {
      const newTheme = document.body.getAttribute("data-theme") === "light" ? "dark" : "light";
      document.body.setAttribute("data-theme", newTheme);
      localStorage.setItem("theme", newTheme);
      darkModeToggle.textContent = newTheme === "dark" ? "‚òÄÔ∏è" : "üåô";
    });

    // üå≥ Load tree data from localStorage
    let storedTrees = JSON.parse(localStorage.getItem("greentrace_trees")) || [];
    
    // Calculate real statistics
    const totalTrees = storedTrees.length;
    const verifiedTrees = storedTrees.filter(tree => tree.verified).length;
    const uniqueSpecies = new Set(storedTrees.map(tree => tree.species || tree.treeName || "Unknown").filter(name => name !== "Unknown")).size;
    
    // Calculate CO‚ÇÇ offset (average mature tree absorbs 21kg CO‚ÇÇ per year)
    const co2Offset = (verifiedTrees * 21).toFixed(1);

    // üßÆ Update dashboard stats with real data
    document.getElementById("totalTrees").textContent = totalTrees;
    document.getElementById("verifiedTrees").textContent = verifiedTrees;
    document.getElementById("speciesCount").textContent = uniqueSpecies;
    document.getElementById("co2Offset").textContent = `${co2Offset} kg`;
    
    // Update welcome message with user name if available
    const currentUser = JSON.parse(localStorage.getItem("greentrace_user")) || {};
    if (currentUser.name) {
      document.getElementById("welcomeMessage").textContent = `Welcome back, ${currentUser.name}!`;
    }

    // üó∫Ô∏è Map initialization
    setTimeout(initializeMap, 100);
    
    function initializeMap() {
      // Create map with a default view
      const map = L.map('map').setView([-1.286389, 36.817223], 10);
      
      // Add tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 18
      }).addTo(map);
      
      // Add markers for all trees (not just verified)
      if (storedTrees.length > 0) {
        const markers = [];
        
        storedTrees.forEach(tree => {
          // Ensure we have valid coordinates
          const lat = parseFloat(tree.lat);
          const lng = parseFloat(tree.lon);
          
          if (!isNaN(lat) && !isNaN(lng)) {
            // Use different icons for verified vs unverified trees
            const iconColor = tree.verified ? 'green' : 'orange';
            const customIcon = L.divIcon({
              html: `<div style="background-color: ${iconColor}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>`,
              className: 'custom-marker',
              iconSize: [20, 20],
              iconAnchor: [10, 10]
            });
            
            const marker = L.marker([lat, lng], {icon: customIcon}).addTo(map);
            
            // Create popup content
            const statusBadge = tree.verified 
              ? '<span style="color: green; font-weight: bold;">‚úì Verified</span>' 
              : '<span style="color: orange; font-weight: bold;">‚è≥ Pending Verification</span>';
            
            marker.bindPopup(`
              <div style="min-width: 200px;">
                <h4 style="margin: 0 0 8px 0; color: var(--primary);">${tree.treeName || 'Unnamed Tree'}</h4>
                <p style="margin: 4px 0;"><strong>Species:</strong> ${tree.species || tree.treeName || 'Unknown'}</p>
                <p style="margin: 4px 0;"><strong>Planted by:</strong> ${tree.planterName || 'Unknown'}</p>
                <p style="margin: 4px 0;"><strong>Location:</strong> ${tree.location || 'Unknown'}</p>
                <p style="margin: 4px 0;"><strong>Status:</strong> ${statusBadge}</p>
                ${tree.plantedDate ? `<p style="margin: 4px 0;"><strong>Planted:</strong> ${new Date(tree.plantedDate).toLocaleDateString()}</p>` : ''}
              </div>
            `);
            markers.push(marker);
          }
        });
        
        // Update map info text
        document.getElementById("mapInfo").textContent = 
          `Showing ${storedTrees.length} trees (${verifiedTrees} verified) on the map.`;
        
        // Fit map to show all markers if we have any
        if (markers.length > 0) {
          const group = new L.featureGroup(markers);
          map.fitBounds(group.getBounds().pad(0.1));
        }
      } else {
        // If no trees, show a message
        document.getElementById("mapInfo").textContent = 
          "No trees yet ‚Äî add your first tree to get started!";
          
        L.marker([-1.286389, 36.817223])
          .addTo(map)
          .bindPopup('<div style="text-align: center;"><strong>No trees yet</strong><br>Add your first tree to see it here!</div>')
          .openPopup();
      }
      
      // Force map refresh to ensure it renders correctly
      setTimeout(() => {
        map.invalidateSize();
      }, 200);
    }

    // Logout
    window.logout = function() {
      if (confirm("Are you sure you want to log out?")) {
        // Clear user session but keep tree data
        localStorage.removeItem("greentrace_user");
        location.href = "login.html";
      }
    };
  });
  </script>
</body>
</html>