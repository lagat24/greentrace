<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard - GreenTrace</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    :root {
      --primary: #2e7d32;        
      --accent: #4caf50;        
      --light: #f4fff4; 
      --card: #ffffff;        
      --text: #163d2c;    
      --muted: #6b6b6b;   
      --border: #e6efe6;    
      --radius: 10px;
      --max-width: 1200px;
      --shadow: 0 6px 18px rgba(0,0,0,0.06);
    }

    [data-theme="dark"] {
      --primary: #4caf50;    
      --accent: #66bb6a;      
      --light: #121212;     
      --card: #1e1e1e;        
      --text: #e0e0e0;         
      --muted: #a0a0a0;         
      --border: #333333;        
      --shadow: 0 6px 18px rgba(0,0,0,0.3);
    }

    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: var(--light);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }

    /* Navigation */
    .nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 18px;
      max-width: var(--max-width);
      margin: 12px auto;
      flex-wrap: wrap;
      gap: 10px;
    }

    .nav-left {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .brand {
      display: flex;
      align-items: center;
      text-decoration: none;
      color: var(--primary);
      gap: 10px;
      font-weight: 700;
      font-size: 1.5rem;
    }

    .logo-img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      box-shadow: 0 2px 6px rgba(46,125,50,0.12);
    }

    .tagline {
      font-style: italic;
      font-size: 14px;
      color: var(--accent);
      letter-spacing: 0.5px;
      margin-top: 4px;
    }

    .nav-links {
      display: flex;
      align-items: center;
      gap: 14px;
      flex-wrap: wrap;
    }

    .nav-links a {
      text-decoration: none;
      color: var(--text);
      font-weight: 500;
    }

    .nav-links a:hover {
      color: var(--primary);
    }

    .dark-toggle {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 1.4rem;
      color: var(--text);
      transition: transform 0.3s ease;
      padding: 4px;
    }

    .dark-toggle:hover {
      transform: rotate(20deg);
    }

    /* Dashboard */
    .dashboard {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 20px;
    }

    .welcome-section {
      background: linear-gradient(135deg, rgba(46, 125, 50, 0.1), rgba(76, 175, 80, 0.05));
      border-radius: var(--radius);
      padding: 30px;
      margin-bottom: 30px;
      border: 1px solid var(--border);
    }

    .welcome-section h1 {
      color: var(--primary);
      margin: 0 0 10px 0;
      font-size: 2rem;
      font-weight: 700;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      text-align: center;
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0 0 8px 0;
    }

    .stat-label {
      color: var(--muted);
      font-size: 0.9rem;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 30px;
    }

    .map-section, .actions-section, .charts-section {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    #map {
      width: 100%;
      height: 400px;
      border-radius: var(--radius);
    }

    .section-title {
      color: var(--primary);
      margin: 0 0 20px 0;
      font-size: 1.3rem;
      font-weight: 600;
    }

    .quick-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .action-btn {
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 15px 20px;
      border-radius: var(--radius);
      text-decoration: none;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .action-btn:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-2px);
    }

    .footer {
      text-align: center;
      color: var(--muted);
      margin-top: 40px;
      padding: 20px 0;
      border-top: 1px solid var(--border);
      font-size: 0.9rem;
    }

    @media (max-width: 768px) {
      .nav { flex-direction: column; text-align: center; }
      .nav-links { justify-content: center; }
      .tagline { display: none; }
      .dashboard-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav" aria-label="Main navigation">
    <div class="nav-left">
      <a class="brand" href="index.html" aria-label="GreenTrace home">
        <img src="../frontend/images/image.png" alt="GreenTrace logo" class="logo-img" />
        <span>GreenTrace</span>
      </a>
      <p class="tagline">Track and Celebrate Tree Planting</p>
    </div>

    <div class="nav-links">
      <a href="dashboard.html" style="color:var(--accent); font-weight:bold;">Dashboard</a>
      <a href="add-tree.html">My Trees</a>
      <a href="ai-scout.html">AI Scout</a>
      <a href="leaderboard.html">Leaderboard</a>
      <a href="#" onclick="logout()">Logout</a>
      <button id="darkModeToggle" class="dark-toggle" aria-label="Toggle dark mode">üåô</button>
    </div>
  </nav>

  <!-- Dashboard -->
  <main class="dashboard">
    <section class="welcome-section">
      <h1 id="welcomeMessage">Welcome back!</h1>
      <p>Here's your current impact snapshot:</p>
    </section>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="totalTrees">0</div>
        <div class="stat-label">Total Trees Planted</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="co2Offset">0 kg</div>
        <div class="stat-label">CO‚ÇÇ Offset</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="leaderboardRank">#0</div>
        <div class="stat-label">Leaderboard Rank</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="speciesCount">0</div>
        <div class="stat-label">Species Planted</div>
      </div>
    </div>

    <div class="dashboard-grid">
      <div>
        <section class="map-section">
          <h3 class="section-title">My Trees Map</h3>
          <div id="map"></div>
          <p id="mapTreesCount" style="margin-top:10px; color:var(--muted);"></p>
        </section>

        <section class="charts-section" style="margin-top:30px;">
          <h3 class="section-title">Impact Overview</h3>
          <p id="monthlyTrees">Loading monthly data...</p>
          <p id="speciesDistribution">Loading species data...</p>
        </section>
      </div>

      <div>
        <section class="actions-section">
          <h3 class="section-title">Quick Actions</h3>
          <div class="quick-actions">
            <a href="add-tree.html" class="action-btn">Add New Tree</a>
            <a href="ai-scout.html" class="action-btn">Explore Land with AI</a>
            <a href="leaderboard.html" class="action-btn">View Insights</a>
          </div>
        </section>
      </div>
    </div>

    <footer class="footer">
      <div>Powered by SDG 15 ‚Äî Life on Land</div>
    </footer>
  </main>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      // Theme
      const darkModeToggle = document.getElementById("darkModeToggle");
      const theme = localStorage.getItem("theme") || "light";
      document.body.setAttribute("data-theme", theme);
      darkModeToggle.textContent = theme === "dark" ? "‚òÄÔ∏è" : "üåô";
      darkModeToggle.addEventListener("click", () => {
        const newTheme = document.body.getAttribute("data-theme") === "light" ? "dark" : "light";
        document.body.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        darkModeToggle.textContent = newTheme === "dark" ? "‚òÄÔ∏è" : "üåô";
      });

      // Fetch data
      let trees = [];
      try {
        const response = await fetch("https://api.greentrace.org/trees");
        if (!response.ok) throw new Error("Failed to fetch data");
        trees = await response.json();
      } catch (err) {
        console.warn("Using local fallback data:", err);
        trees = JSON.parse(localStorage.getItem("trees")) || [];
      }

      // Compute stats
      const verified = trees.filter(t => t.verified);
      const total = trees.length;
      const uniqueSpecies = new Set(trees.map(t => t.species?.toLowerCase())).size;
      const co2Total = trees.reduce((sum, t) => sum + (t.co2Offset || 21), 0);

      document.getElementById("totalTrees").textContent = total.toLocaleString();
      document.getElementById("speciesCount").textContent = uniqueSpecies;
      document.getElementById("co2Offset").textContent = co2Total.toLocaleString() + " kg";
      document.getElementById("leaderboardRank").textContent = "#" + Math.max(1, 100 - total);
      document.getElementById("mapTreesCount").textContent = verified.length
        ? `${verified.length} verified tree${verified.length > 1 ? "s" : ""} shown on map.`
        : "No verified trees found.";

      // Initialize map
      const map = L.map("map").setView([-1.286389, 36.817223], 7);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

      verified.forEach(t => {
        const popup = `
          <b>${t.treeName || "Tree"}</b><br>
          <i>${t.species || "Unknown species"}</i><br>
          üåç ${t.location || "Unknown location"}<br>
          üë§ ${t.planterName || "Anonymous"}
        `;
        L.marker([t.lat, t.lon]).addTo(map).bindPopup(popup);
      });

      if (verified.length > 0) {
        const bounds = L.latLngBounds(verified.map(t => [t.lat, t.lon]));
        map.fitBounds(bounds);
      }

      // Cache data
      localStorage.setItem("trees", JSON.stringify(trees));
    });

    function logout() {
      if (confirm("Are you sure you want to log out?")) {
        localStorage.clear();
        location.href = "login.html";
      }
    }
  </script>
</body>
</html>
