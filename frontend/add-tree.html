<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GreenTrace ‚Äî My Trees</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>

  <!-- App styles -->
  <link rel="stylesheet" href="../frontend/styles/style.css" />

  <style>
    .map { height: 400px; border-radius: 10px; margin-top: 10px; }
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .tree-card {
      background: var(--card);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 1rem;
      text-align: center;
      border: 1px solid var(--border);
      position: relative;
    }
    .tree-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 8px;
    }
    .verified { color: #4caf50; font-weight: 600; }
    .not-verified { color: #f44336; font-weight: 600; }
    .confidence { font-size: 0.8rem; color: var(--muted); margin-top: 5px; }
    .delete-btn {
      background: #f44336;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      margin-top: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .delete-btn:hover { background: #d32f2f; }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--primary);
      color: white;
      padding: 12px 18px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
      font-weight: 500;
    }
    .toast.show { opacity: 1; }
    .toast.success { background: var(--accent); }
    .toast.error { background: #f44336; }
    .toast.warning { background: #ff9800; }
    .progress-bar { width: 100%; height: 4px; background: var(--border); border-radius: 2px; margin: 10px 0; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s ease; }
    .verification-details { background: rgba(76, 175, 80, 0.1); padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 0.9rem; }
  </style>
</head>

<body>
  <!-- NAV -->
  <nav class="nav" aria-label="Main navigation">
    <div class="nav-left">
      <a class="brand" href="index.html" aria-label="GreenTrace home">
        <img src="../frontend/images/image.png" alt="GreenTrace logo" class="logo-img" />
        <span>GreenTrace</span>
      </a>
      <p class="tagline">Track and Celebrate Tree Planting</p>
    </div>

    <div class="nav-links">
      <a href="dashboard.html">Dashboard</a> 
      <a href="add-tree.html" aria-current="page" style="color:var(--accent); font-weight:bold;">My Trees</a>
      <a href="ai-scout.html">AI Scout</a>
      <a href="leaderboard.html">Leaderboard</a>
      <a href="#" onclick="logout()">Logout</a>
      <button id="darkModeToggle" class="dark-toggle" aria-pressed="false" aria-label="Toggle dark mode">üåô</button>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="container" role="main">
    <section class="map-section card">
      <h2>My Planted Trees Map</h2>
      <div id="map" class="map" aria-label="Map showing my planted trees"></div>
    </section>

    <section class="form-section card">
      <h2>Add a Tree üå±</h2>
      <form id="treeForm" class="tree-form" novalidate role="form">
        <label>Tree name
          <input type="text" id="treeName" placeholder="e.g., Mugumo" required>
        </label>

        <label>Planter name
          <input type="text" id="planterName" placeholder="Your full name" required>
        </label>

        <label>Location
          <select id="locationSelect" required>
            <option value="">Loading locations...</option>
          </select>
        </label>

        <label>Tree Image (Required for AI Verification)
          <input type="file" id="treeImage" accept="image/*" required>
          <small style="color: var(--muted); font-size: 0.8rem;">Take a clear photo of the planted tree/sapling for AI verification</small>
        </label>

        <label>Description (optional)
          <textarea id="description" rows="3" placeholder="Why was this tree planted?"></textarea>
        </label>

        <div id="verificationProgress" class="hidden">
          <div class="verification-details">
            <strong>AI Verification in Progress</strong>
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
            <div id="verificationStatus">Analyzing image...</div>
          </div>
        </div>

        <div class="form-actions">
          <button id="submitTreeBtn" class="btn primary" type="submit">Add Tree üå≥</button>
          <button id="center-my-trees" type="button" class="btn secondary">Center on my trees</button>
        </div>
      </form>
    </section>

    <section class="gallery-section card">
      <h2>My Verified Trees</h2>
      <div id="treeGallery" class="gallery-grid"></div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <footer class="footer"><small>Powered by SDG 15 ‚Äî Life on Land</small></footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
  let map, trees = [], aiModel = null, kenyaLocations = [];

  document.addEventListener("DOMContentLoaded", async () => {
    // Dark mode üåô
    const darkModeToggle = document.getElementById("darkModeToggle");
    const theme = localStorage.getItem("theme") || "light";
    document.body.setAttribute("data-theme", theme);
    darkModeToggle.textContent = theme === "dark" ? "‚òÄÔ∏è" : "üåô";
    darkModeToggle.addEventListener("click", () => {
      const newTheme = document.body.getAttribute("data-theme") === "light" ? "dark" : "light";
      document.body.setAttribute("data-theme", newTheme);
      localStorage.setItem("theme", newTheme);
      darkModeToggle.textContent = newTheme === "dark" ? "‚òÄÔ∏è" : "üåô";
    });

    // Initialize map
    map = L.map("map").setView([-1.286389, 36.817223], 7);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    setTimeout(() => map.invalidateSize(), 500);

    const toast = document.getElementById("toast");
    const gallery = document.getElementById("treeGallery");
    const form = document.getElementById("treeForm");
    const locationSelect = document.getElementById("locationSelect");
    const verificationProgress = document.getElementById("verificationProgress");
    const progressFill = document.getElementById("progressFill");
    const verificationStatus = document.getElementById("verificationStatus");

    // Load Kenya locations
    try {
      const res = await fetch("../frontend/location.json");
      kenyaLocations = await res.json();
      locationSelect.innerHTML = kenyaLocations.map(l => `<option value="${l.name}">${l.name}</option>`).join("");
    } catch {
      locationSelect.innerHTML = `<option value="Nairobi">Nairobi</option>`;
    }

    // Load AI model
    try {
      showToast("Loading AI model...", "info");
      aiModel = await tf.loadLayersModel("../frontend/models/tree-model/model.json");
      showToast("AI model ready ‚úÖ", "success");
    } catch {
      aiModel = null;
      showToast("Using fallback AI verification", "warning");
    }

    const storageKey = "greentrace_trees";
    trees = JSON.parse(localStorage.getItem(storageKey)) || [];
    trees.forEach(renderTree);
    updateMap();

    form.addEventListener("submit", async e => { e.preventDefault(); await handleTreeSubmission(); });
    document.getElementById("center-my-trees").addEventListener("click", centerOnTrees);

    async function handleTreeSubmission() {
      const treeName = document.getElementById("treeName").value.trim();
      const planterName = document.getElementById("planterName").value.trim();
      const location = locationSelect.value;
      const description = document.getElementById("description").value.trim();
      const imageFile = document.getElementById("treeImage").files[0];
      if (!imageFile) return showToast("Please upload a tree image!", "error");

      const submitBtn = document.getElementById("submitTreeBtn");
      submitBtn.disabled = true; submitBtn.textContent = "Verifying...";
      verificationProgress.classList.remove("hidden");

      try {
        updateProgress(30, "Reading image...");
        const imageBase64 = await toBase64(imageFile);
        updateProgress(60, "Analyzing...");

        const result = aiModel ? await verifyWithTensorFlow(imageBase64) : await basicImageAnalysis(imageBase64);

        if (result.verified) {
          const locationData = kenyaLocations.find(l => l.name === location);
          const lat = locationData?.lat || -1.29 + Math.random() * 0.2;
          const lon = locationData?.lng || 36.82 + Math.random() * 0.2;

          const newTree = { id: Date.now(), treeName, planterName, location, description, lat, lon, image: imageBase64, verified: true, confidence: result.confidence, plantedAt: new Date() };
          trees.push(newTree);
          localStorage.setItem(storageKey, JSON.stringify(trees));
          renderTree(newTree);
          updateMap();
          form.reset();
          showToast(`‚úÖ ${result.message}`, "success");
        } else showToast(`‚ùå ${result.message}`, "error");
      } catch (e) {
        console.error(e);
        showToast("Verification failed", "error");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Add Tree üå≥";
        verificationProgress.classList.add("hidden");
        progressFill.style.width = "0%";
      }
    }

    function renderTree(t) {
      const card = document.createElement("div");
      card.className = "tree-card";
      card.innerHTML = `
        <img src="${t.image}" alt="${t.treeName}">
        <h3>${escapeHtml(t.treeName)}</h3>
        <p><b>Planter:</b> ${escapeHtml(t.planterName)}</p>
        <p>${escapeHtml(t.location)}</p>
        <p class="${t.verified ? "verified" : "not-verified"}">${t.verified ? "‚úÖ AI Verified" : "‚ùå Unverified"}</p>
        <div class="confidence">${(t.confidence * 100).toFixed(1)}% confidence</div>
        <button class="delete-btn" data-id="${t.id}"><i class="fas fa-trash"></i> Delete</button>
      `;
      gallery.appendChild(card);
      card.querySelector(".delete-btn").addEventListener("click", () => deleteTree(t.id));
    }

    function deleteTree(id) {
      if (!confirm("Are you sure you want to delete this tree?")) return;
      trees = trees.filter(t => t.id !== id);
      localStorage.setItem(storageKey, JSON.stringify(trees));
      document.getElementById("treeGallery").innerHTML = "";
      trees.forEach(renderTree);
      updateMap();
      showToast("üå≥ Tree deleted successfully", "success");
    }

    async function verifyWithTensorFlow(base64) {
      const img = await createImage(base64);
      const tensor = tf.browser.fromPixels(img).resizeBilinear([224, 224]).div(255).expandDims(0);
      const preds = aiModel.predict(tensor);
      const data = await preds.data();
      const confidence = Math.max(...data);
      const verified = confidence > 0.6;
      tf.dispose([tensor, preds]);
      return { verified, confidence, message: verified ? `Tree detected (${(confidence * 100).toFixed(1)}%)` : `No tree detected (${(confidence * 100).toFixed(1)}%)` };
    }

    function createImage(src) {
      return new Promise((res, rej) => { const img = new Image(); img.onload = () => res(img); img.onerror = rej; img.src = src; });
    }

    async function basicImageAnalysis(base64) {
      return new Promise(res => {
        const img = new Image(); img.src = base64;
        img.onload = () => {
          const c = document.createElement("canvas"), ctx = c.getContext("2d");
          c.width = img.width; c.height = img.height;
          ctx.drawImage(img, 0, 0);
          const d = ctx.getImageData(0, 0, c.width, c.height).data;
          let g = 0;
          for (let i = 0; i < d.length; i += 4) {
            let r = d[i], g1 = d[i + 1], b = d[i + 2];
            if (g1 > r + 20 && g1 > b + 20 && g1 > 60) g++;
          }
          const conf = Math.min((g / (d.length / 4)) / 0.3, 0.95);
          res({ verified: conf > 0.4, confidence: conf, message: conf > 0.4 ? `Tree-like features detected (${(conf * 100).toFixed(1)}%)` : `Low confidence (${(conf * 100).toFixed(1)}%)` });
        };
      });
    }

    function updateProgress(p, t) { progressFill.style.width = p + "%"; verificationStatus.textContent = t; }
    function toBase64(file) { return new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(file); }); }
    function centerOnTrees() {
      const group = L.featureGroup(trees.filter(t => t.verified).map(t => L.marker([t.lat, t.lon])));
      if (trees.length) map.fitBounds(group.getBounds()); else showToast("No trees to center", "warning");
    }
    function updateMap() {
      map.eachLayer(l => { if (l instanceof L.Marker) map.removeLayer(l); });
      trees.filter(t => t.verified).forEach(t => {
        L.marker([t.lat, t.lon]).addTo(map).bindPopup(`<b>${escapeHtml(t.treeName)}</b><br>${escapeHtml(t.planterName)}<br>${escapeHtml(t.location)}`);
      });
    }
    function showToast(m, t = "info") { toast.textContent = m; toast.className = `toast ${t} show`; setTimeout(() => toast.classList.remove("show"), 4000); }
    function escapeHtml(t) { const d = document.createElement("div"); d.textContent = t; return d.innerHTML; }
    function logout() { if (confirm("Log out?")) { localStorage.clear(); location.href = "login.html"; } }
  });
  </script>
</body>
</html>
